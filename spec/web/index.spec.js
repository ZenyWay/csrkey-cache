(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
"use strict";var src_1=require("../src"),base64=require("base64-js"),csrng,cache;beforeEach(function(){csrng=jasmine.createSpy("csrng").and.returnValue(Uint8Array.of(42)),cache=jasmine.createSpyObj("cache",["set","del","get","has"])}),describe("default export: getCache <V>(opts?: CsrKeyCacheFactoryOpts<V>): CsrKeyCache<V>",function(){var e;beforeEach(function(){e=jasmine.objectContaining({set:jasmine.any(Function),del:jasmine.any(Function),get:jasmine.any(Function),has:jasmine.any(Function)})}),describe("when called without arguments",function(){var t;beforeEach(function(){t=src_1.default()}),it("returns a CsrKeyCache<V> instance",function(){expect(t).toEqual(e)})}),describe("when called with { cache: Cache<string, V> }",function(){var t;beforeEach(function(){t=src_1.default({cache:cache}),t.set("foo",42),t.del("foo"),t.get("foo"),t.has("foo")}),it("returns a CsrKeyCache<V> instance that wraps the given cache instance",function(){expect(cache).toEqual(e),expect(cache.set).toHaveBeenCalledWith(jasmine.any(String),"foo",42),expect(cache.del).toHaveBeenCalledWith("foo"),expect(cache.get).toHaveBeenCalledWith("foo"),expect(cache.has).toHaveBeenCalledWith("foo")})}),describe("when called with { cache: LruCacheOptions<V> }",function(){var t,a;beforeEach(function(){t=src_1.default({cache:{max:1}});var e=t.set("foo"),n=t.set("bar");a={foo:t.get(e),bar:t.get(n)}}),it("returns a CsrKeyCache<V> instance that wraps an lru-cache instance with the given options",function(){expect(t).toEqual(e),expect(a).toEqual(jasmine.objectContaining({foo:void 0,bar:"bar"}))})}),describe("when called with { keylength: number }",function(){var t,a;beforeEach(function(){t=src_1.default({keylength:42}),a=base64.toByteArray(t.set("foo"))}),it("returns a CsrKeyCache<V> instance that generates random base64 keys of the given number of bytes",function(){expect(t).toEqual(e),expect(a.length).toBe(42)})}),describe("when called with { csrng: (length: number) => Uint8Array }",function(){var t,a;beforeEach(function(){t=src_1.default({csrng:csrng}),a=t.set("foo")}),it("returns a CsrKeyCache<V> instance that generates random base64 keys with the given random number generator",function(){expect(t).toEqual(e),expect(a).toBe("Kg=="),expect(csrng).toHaveBeenCalledWith(jasmine.any(Number))})})}),describe("CsrKeyCache<V>",function(){var e;beforeEach(function(){e=src_1.default({cache:cache,keylength:6502,csrng:csrng})}),describe("set (val: V, expire?: number): string|false",function(){var t,a,n;beforeEach(function(){t="Kg==";var c=!0;cache.set.and.callFake(function(){return c=!0}),cache.has.and.callFake(function(){return!(c=!c)}),a=e.set("bar"),cache.has.and.returnValue(!1),n=e.set("baz",6510)}),it("generates and returns a unique base64 string key from random bytes generated by the CSRNG ",function(){expect(a).toBe(t),expect(csrng).toHaveBeenCalledWith(6502),expect(csrng).toHaveBeenCalledTimes(3)}),it("stores the given `val` in the cache under the generated key ",function(){expect(cache.set.calls.argsFor(0)).toEqual([t,"bar",void 0]),expect(cache.set.calls.argsFor(1)).toEqual([t,"baz",6510])}),it("returns false upon failure",function(){expect(n).toBe(!1)})}),describe("del (key: string): void",function(){beforeEach(function(){e.del("foo")}),it("delegates to the `del` method of the underlying cache",function(){expect(cache.del).toHaveBeenCalledWith("foo")})}),describe("get (key: string): V",function(){var t;beforeEach(function(){cache.get.and.returnValue("bar"),t=e.get("foo")}),it("delegates to the `get` method of the underlying cache",function(){expect(cache.get).toHaveBeenCalledWith("foo"),expect(t).toBe("bar")})}),describe("has (key: string): boolean",function(){var t;beforeEach(function(){cache.has.and.returnValue(!0),t=e.has("foo")}),it("delegates to the `has` method of the underlying cache",function(){expect(cache.has).toHaveBeenCalledWith("foo"),expect(t).toBe(!0)})})});
},{"../src":2,"base64-js":undefined}],2:[function(require,module,exports){
"use strict";function isCache(e){return!!e&&[e.set,e.get,e.del,e.has].every(isFunction)}function isFunction(e){return"function"==typeof e}function getLruCache(e){var t=require("lru-cache"),s=tslib_1.__assign({},lruDefaults,e);return t(s)}var base64=require("base64-js"),tslib_1=require("tslib"),configDefaults={keylength:32},CsrKeyCacheClass=function(){function e(e,t,s){this.cache=e,this.keylength=t,this.getRandomBytes=s}return e.prototype.set=function(e,t){var s=this.getNewKey();return this.cache.set(s,e,t),this.cache.has(s)&&s},e.prototype.del=function(e){return this.cache.del(e)},e.prototype.get=function(e){return this.cache.get(e)},e.prototype.has=function(e){return this.cache.has(e)},e.prototype.getNewKey=function(){var e=this.getRandomBytes(this.keylength),t=base64.fromByteArray(e);return this.cache.has(t)?this.getNewKey():t},e}();CsrKeyCacheClass.getInstance=function(e){var t=tslib_1.__assign({},configDefaults,e),s=isCache(t.cache)?t.cache:getLruCache(t.cache),r=t.csrng||require("randombytes");return new CsrKeyCacheClass(s,t.keylength,r)};var lruDefaults={max:1024,maxAge:9e5},getCsrKeyCache=CsrKeyCacheClass.getInstance;Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=getCsrKeyCache;
},{"base64-js":undefined,"lru-cache":undefined,"randombytes":undefined,"tslib":undefined}]},{},[1]);
